<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Skills | DataOrchestrator - Data Platform & AI Agent</title>
    <script src="./components/api-client.js" type="module"></script>
    <style>
      .json-block {
        font-family: ui-monospace, 'Cascadia Code', 'Source Code Pro', Menlo, Monaco, Consolas, monospace;
        font-size: 0.75rem;
        line-height: 1.4;
        max-height: 14rem;
        overflow: auto;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        background: rgba(0,0,0,0.04);
        border: 1px solid rgba(0,0,0,0.08);
      }
      .dark .json-block {
        background: rgba(255,255,255,0.06);
        border-color: rgba(255,255,255,0.1);
      }
      .skill-result-summary {
        font-size: 0.8125rem;
        padding: 0.35rem 0.6rem;
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
        display: inline-block;
      }
      .skill-result-summary.ok { background: #dcfce7; color: #166534; }
      .dark .skill-result-summary.ok { background: rgba(34,197,94,0.2); color: #86efac; }
      .skill-result-summary.fail { background: #fee2e2; color: #991b1b; }
      .dark .skill-result-summary.fail { background: rgba(239,68,68,0.2); color: #fca5a5; }
    </style>
  </head>
  <body
    x-data="{
      page: 'skills',
      'loaded': true,
      'darkMode': false,
      'stickyMenu': false,
      'sidebarToggle': false,
      'scrollTop': false,
      
      // Skills data
      skills: [],
      selectedSkill: null,
      
      // File for skill (upload or path): passed as context.file_path / context.file_paths
      filePathForSkill: '',
      skillFilePaths: [],
      isUploading: false,
      uploadError: null,
      
      // Chat with skill
      message: '',
      messages: [],
      currentSession: null,
      isLoading: false,
      error: null,
      
      // Plan execution
      executionPlan: null,
      executionResult: null,
      isExecuting: false
    }"
    x-init="
      // 解析 skill 结果用于友好展示
      window.formatSkillResult = function(content) {
        if (!content || typeof content !== 'string') return { isSkillResult: false, text: content || '' };
        var t = content.trim();
        if (!t.startsWith('{')) return { isSkillResult: false, text: content };
        try {
          var o = JSON.parse(content);
          if (!o || typeof o !== 'object') return { isSkillResult: false, text: content };
          var results = o.results || [];
          var total = results.length;
          var successCount = results.filter(function(r) { return r.success; }).length;
          var totalTime = results.reduce(function(s, r) { return s + (r.execution_time || 0); }, 0);
          var allOk = total && successCount === total;
          var summary = total ? (allOk ? '成功' : '部分失败') + ' · ' + total + ' 步 · ' + totalTime.toFixed(2) + 's' : '已执行';
          var steps = results.map(function(r) { return { action: r.action || '', success: r.success, output: r.output || '', time: r.execution_time }; });
          return { isSkillResult: true, summary: summary, allOk: allOk, json: content, steps: steps };
        } catch (e) {
          return { isSkillResult: false, text: content };
        }
      };
      window.parseUserSkillMessage = function(content) {
        if (!content || typeof content !== 'string') return { skill: '', request: content || '' };
        var m = content.match(/Using skill:\s*(\w+)\.\s*(.+)/i);
        if (m) return { skill: m[1], request: m[2].trim() };
        return { skill: '', request: content };
      };
      window.formatExecutionPlanSummary = function(plan) {
        if (!plan || !plan.steps) return 'Execution Plan';
        return 'Execution Plan · ' + plan.steps.length + ' step' + (plan.steps.length > 1 ? 's' : '');
      };
      window.formatExecutionResultSummary = function(result) {
        if (!result || !result.results) return 'Execution Result';
        var n = result.results.length;
        var ok = result.results.filter(function(r) { return r.success; }).length;
        return 'Execution Result · ' + (ok === n ? '✓ 成功' : '✗ 失败') + ' (' + ok + '/' + n + ')';
      };
      // 从 skill 执行结果中提取可下载的输出文件路径（用于「下载」按钮，用户可另存为）
      window.getSkillResultOutputPaths = function(content) {
        var out = [];
        if (!content || typeof content !== 'string') return out;
        try {
          var o = JSON.parse(content);
          var push = function(text) {
            if (!text || typeof text !== 'string') return;
            var m = text.match(/into\s+(.+?)(?:\n|$)/) || text.match(/Written to\s+(.+?)(?:\n|$)/i) || text.match(/saved to\s+(.+?)(?:\n|$)/i) || text.match(/output[:\s]+\s*(.+?)(?:\.\s|$|\n)/i);
            if (m) {
              var p = m[1].replace(/\\\\/g, '\\').trim();
              if (p && out.indexOf(p) === -1) out.push(p);
            }
          };
          (o.results || []).forEach(function(r) { push(r.output); });
          var fo = o.final_output || {};
          Object.keys(fo).forEach(function(k) { if (/^step_\d+_output$/.test(k)) push(fo[k]); });
        } catch (e) {}
        return out;
      };
      window.getDownloadUrl = function(filePath) {
        var base = (typeof window !== 'undefined' && window.APIClient) ? new window.APIClient('opencode_agent').getBaseUrl() : '';
        if (!base) base = 'http://localhost:8001';
        return base + '/download?path=' + encodeURIComponent(filePath);
      };

      darkMode = JSON.parse(localStorage.getItem('darkMode'));
      $watch('darkMode', value => localStorage.setItem('darkMode', JSON.stringify(value)));
      if (!localStorage.getItem('token')) {
        window.location.href = 'login.html';
      }
      
      // Load skills on page load
      window.loadSkills = async function() {
        try {
          const client = new APIClient('opencode_agent');
          const response = await client.listSkills();
          const all = response.skills || [];
          // 目前只暴露 pdf / xlsx 两个 skill
          skills = all.filter(s => ['pdf', 'xlsx'].includes(s.name));
          // 默认选中第一个 skill，避免右侧输入框和按钮一开始是禁用状态
          if (!selectedSkill && skills.length > 0) {
            selectedSkill = skills[0];
          }
          console.log('Loaded skills (pdf, xlsx only):', skills);
        } catch (err) {
          error = err.message || 'Failed to load skills';
          console.error('Failed to load skills:', err);
        }
      };
      
      window.loadSkills();
      
      window.logout = async function() {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = 'login.html';
      };
      
      // Execute skill
      window.executeSkill = async function() {
        if (!selectedSkill || !message.trim()) return;
        
        isExecuting = true;
        error = null;
        executionPlan = null;
        executionResult = null;
        
        const userMsg = { role: 'user', content: `Using skill: ${selectedSkill.name}. ${message}` };
        messages = [...messages, userMsg];
        const msgToSend = message;
        message = '';
        
        const context = {};
        // 多文件：优先使用 skillFilePaths 数组，同时兼容单个 file_path
        if (skillFilePaths && skillFilePaths.length > 0) {
          context.file_paths = [...skillFilePaths];
          context.file_path = skillFilePaths[0];
        } else if (filePathForSkill && filePathForSkill.trim()) {
          context.file_path = filePathForSkill.trim();
        }
        
        try {
          const client = new APIClient('opencode_agent');
          const response = await client.executeSkill(
            selectedSkill.name,
            msgToSend,
            context
          );
          
          const assistantMsg = { 
            role: 'assistant', 
            content: response.result ? JSON.stringify(response.result, null, 2) : 'Skill executed',
            plan: response.plan 
          };
          messages = [...messages, assistantMsg];
          
          executionPlan = response.plan;
          executionResult = response.result;
          
        } catch (err) {
          error = err.message || 'Failed to execute skill';
          const errorMsg = { role: 'assistant', content: `Error: ${error}` };
          messages = [...messages, errorMsg];
        } finally {
          isExecuting = false;
          // Auto scroll to bottom
          setTimeout(() => {
            const container = document.getElementById('messages-container');
            container.scrollTop = container.scrollHeight;
          }, 100);
        }
      };
      
      window.handleSkillFileUpload = async function(event) {
        const file = event.target.files && event.target.files[0];
        if (!file) return;
        isUploading = true;
        uploadError = null;
        filePathForSkill = '';
        try {
          const client = new APIClient('opencode_agent');
          const res = await client.uploadFile(file);
          filePathForSkill = res.filePath || '';
        } catch (err) {
          uploadError = err.message || 'Upload failed';
        } finally {
          isUploading = false;
          event.target.value = '';
        }
      };

      // 从左侧 FILES 面板选择文件时，支持多文件：累积到 skillFilePaths
      window.selectSkillFileFromSidebar = function(file) {
        if (!file) return;
        const path = file.filePath || file.name;
        if (!path) return;

        if (!skillFilePaths.includes(path)) {
          skillFilePaths.push(path);
        }

        if (file.filePath) {
          filePathForSkill = skillFilePaths.join(', ');
        } else if (file.name) {
          // 退化为仅使用文件名（主要为了兼容早期本地文件记录）
          filePathForSkill = skillFilePaths.join(', ');
        }
      };
    "
    :class="{'dark bg-gray-900': darkMode === true}"
  >
    <!-- ===== Preloader Start ===== -->
    <include src="./partials/preloader.html"></include>
    <!-- ===== Preloader End ===== --> 

    <!-- ===== Page Wrapper Start ===== -->
    <div class="flex h-screen overflow-hidden">
      <!-- ===== Sidebar Start ===== -->
      <include src="./partials/sidebar-custom.html"></include>
      <!-- ===== Sidebar End ===== --> 

      <!-- ===== Content Area Start ===== -->
      <div
        class="relative flex flex-col flex-1 overflow-x-hidden overflow-y-auto"
      >
        <!-- Small Device Overlay Start -->
        <include src="./partials/overlay.html" />
        <!-- Small Device Overlay End --> 

        <!-- ===== Header Start ===== -->
        <include src="./partials/header-custom.html" />
        <!-- ===== Header End ===== --> 

        <!-- ===== Main Content Start ===== -->
        <main class="flex-1 flex flex-col">
          <div class="flex-1 p-4 mx-auto max-w-(--breakpoint-2xl) md:p-6 w-full">
            <!-- Page Title -->
            <div class="mb-6">
              <h1 class="mb-1 font-semibold text-gray-800 text-title-md dark:text-white/90">
                Skills
              </h1>
              <p class="text-sm text-gray-500 dark:text-gray-400">
                Select a skill to execute specialized tasks (PDF, Excel, etc.)
              </p>
            </div>

            <!-- Skills Selection -->
            <div class="p-6 mb-6 bg-white border border-gray-200 rounded-xl dark:bg-gray-800 dark:border-gray-700">
              <h3 class="mb-4 font-semibold text-gray-800 dark:text-white">
                Available Skills
              </h3>
              
              <!-- Loading state -->
              <template x-if="skills.length === 0 && !error">
                <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                  <svg class="mx-auto mb-2 text-gray-400 animate-spin" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8 0 018 8 0 018-8 0 018 8z"></path>
                  </svg>
                  Loading skills...
                </div>
              </template>

              <!-- Error state -->
              <template x-if="error">
                <div class="p-4 bg-red-50 border border-red-200 rounded-lg text-red-800 dark:bg-red-900/20 dark:border-red-800 dark:text-red-400">
                  <p x-text="error"></p>
                </div>
              </template>

              <!-- Skills list -->
              <template x-if="skills.length > 0">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  <template x-for="skill in skills" :key="skill.name">
                    <div 
                      class="p-4 border rounded-lg cursor-pointer transition-all"
                      :class="selectedSkill?.name === skill.name ? 'border-brand-500 bg-brand-50 dark:bg-brand-900/20' : 'border-gray-200 hover:border-brand-300 dark:border-gray-700 dark:hover:border-brand-600'"
                      @click="selectedSkill = skill"
                    >
                      <h4 class="mb-2 font-semibold text-gray-800 dark:text-white" x-text="skill.name"></h4>
                      <p class="text-xs text-gray-500 dark:text-gray-400 mb-2" x-text="skill.type"></p>
                      <p class="text-sm text-gray-600 dark:text-gray-300 line-clamp-3" x-text="skill.path"></p>
                      <template x-if="skill.metadata?.function_names && skill.metadata.function_names.length > 0">
                        <div class="mt-2">
                          <span class="text-xs text-brand-600 dark:text-brand-400">
                            <span x-text="skill.metadata?.function_names?.length || 0"></span> functions
                          </span>
                        </div>
                      </template>
                    </div>
                  </template>
                </div>
              </template>
            </div>

            <!-- Chat with Skill -->
            <div class="p-6 bg-white border border-gray-200 rounded-xl dark:bg-gray-800 dark:border-gray-700">
              <h3 class="mb-4 font-semibold text-gray-800 dark:text-white">
                Execute Skill
              </h3>
              
              <!-- Selected skill info -->
              <template x-if="selectedSkill">
                <div class="p-3 mb-4 bg-blue-50 border border-blue-200 rounded-lg dark:bg-blue-900/20 dark:border-blue-800">
                  <p class="text-sm text-blue-800 dark:text-blue-400">
                    <span class="font-semibold">Selected:</span> 
                    <span x-text="selectedSkill.name"></span>
                    <span x-show="selectedSkill.metadata?.function_names">
                      (<span x-text="selectedSkill.metadata?.function_names?.length || 0"></span> functions)
                    </span>
                  </p>
                </div>
              </template>

              <!-- File path for skill (context.file_path) -->
              <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">File for skill (optional)</label>
                  <span x-show="skillFilePaths.length > 0" 
                        class="inline-flex items-center justify-center gap-1 rounded-full bg-success-50 px-2.5 py-0.5 text-xs font-medium text-success-600 dark:bg-success-500/15 dark:text-success-500">
                    <span x-text="skillFilePaths.length"></span> file<span x-show="skillFilePaths.length > 1">s</span> selected
                  </span>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">
                  Click a file from the left <strong>FILES</strong> panel, or type a path here.
                </p>
                
                <!-- Selected files display -->
                <div x-show="skillFilePaths.length > 0" class="mb-3">
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <template x-for="(fp, idx) in skillFilePaths" :key="idx">
                      <div class="flex items-center justify-between rounded-xl border border-gray-200 bg-white py-3 pl-3 pr-3 dark:border-gray-700 dark:bg-white/[0.03] hover:border-brand-300 dark:hover:border-brand-600 transition-colors">
                        <div class="flex items-center gap-3 min-w-0">
                          <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-brand-500/[0.08] text-brand-500">
                            <svg class="fill-current" width="20" height="20" viewBox="0 0 20 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M9.05 3.9L8.45 4.35L9.05 3.9ZM2.25 2.25H6.5V0.75H2.25V2.25ZM1.5 15V3H0V15H1.5ZM17.75 15.75H2.25V17.25H17.75V15.75ZM18.5 6V15H20V6H18.5ZM17.75 3.75H10.25V5.25H17.75V3.75ZM9.65 3.45L8.3 1.65L7.1 2.55L8.45 4.35L9.65 3.45ZM10.25 3.75C10.0139 3.75 9.79164 3.63885 9.65 3.45L8.45 4.35C8.87492 4.91656 9.5418 5.25 10.25 5.25V3.75ZM20 6C20 4.75736 18.9926 3.75 17.75 3.75V5.25C18.1642 5.25 18.5 5.58579 18.5 6H20ZM17.75 17.25C18.9926 17.25 20 16.2426 20 15H18.5C18.5 15.4142 18.1642 15.75 17.75 15.75V17.25ZM0 15C0 16.2426 1.00736 17.25 2.25 17.25V15.75C1.83579 15.75 1.5 15.4142 1.5 15H0ZM6.5 2.25C6.73607 2.25 6.95836 2.36115 7.1 2.55L8.3 1.65C7.87508 1.08344 7.2082 0.75 6.5 0.75V2.25ZM2.25 0.75C1.00736 0.75 0 1.75736 0 3H1.5C1.5 2.58579 1.83579 2.25 2.25 2.25V0.75Z" fill=""/>
                            </svg>
                          </div>
                          <div class="min-w-0">
                            <p class="text-sm font-medium text-gray-800 dark:text-white/90 truncate" 
                               x-text="fp.split(/[\/\\]/).pop() || fp"
                               :title="fp"></p>
                            <p class="text-xs text-gray-500 dark:text-gray-400 truncate" x-text="fp"></p>
                          </div>
                        </div>
                        <button @click="skillFilePaths.splice(idx, 1)" 
                                class="ml-2 p-1 text-gray-400 hover:text-red-500 dark:text-gray-500 dark:hover:text-red-400 transition-colors"
                                title="Remove file">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                          </svg>
                        </button>
                      </div>
                    </template>
                  </div>
                </div>
                
                <div class="flex flex-wrap gap-2 items-center">
                  <input
                    type="text"
                    x-model="filePathForSkill"
                    @keydown.enter="if(filePathForSkill.trim()) { skillFilePaths.push(filePathForSkill.trim()); filePathForSkill = ''; }"
                    placeholder="Type path and press Enter (e.g. file:/C:/path/to/file.pdf)"
                    class="flex-1 min-w-[200px] p-2.5 text-sm border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-brand-500 focus:border-transparent"
                  />
                  <button @click="if(filePathForSkill.trim()) { skillFilePaths.push(filePathForSkill.trim()); filePathForSkill = ''; }" 
                          :disabled="!filePathForSkill.trim()"
                          class="px-4 py-2.5 bg-brand-600 text-white text-sm font-medium rounded-lg hover:bg-brand-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
                    Add
                  </button>
                </div>
                <template x-if="uploadError">
                  <div class="mt-2 rounded-lg border border-error-500 bg-error-50 p-3 dark:border-error-500/30 dark:bg-error-500/15">
                    <div class="flex items-start gap-2">
                      <svg class="w-5 h-5 text-error-500 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                      </svg>
                      <p class="text-sm text-error-700 dark:text-error-400" x-text="uploadError"></p>
                    </div>
                  </div>
                </template>
              </div>

              <!-- Message input -->
              <div class="mb-4">
                <textarea
                  x-model="message"
                  placeholder="Describe what you want to do with the selected skill..."
                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                  rows="3"
                  :disabled="!selectedSkill || isExecuting"
                ></textarea>
              </div>

              <!-- Execute button -->
              <button
                @click="executeSkill"
                :disabled="!selectedSkill || !message.trim() || isExecuting"
                class="px-6 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
              >
                <span x-show="isExecuting" class="flex items-center gap-2">
                  <svg class="animate-spin" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8 0 018 8 0 018-8 0 018 8z"></path>
                  </svg>
                  Executing...
                </span>
                <span x-show="!isExecuting">Execute Skill</span>
              </button>
            </div>

            <!-- Execution Results -->
            <div class="flex-1 flex flex-col min-h-0">
              <div 
                id="messages-container" 
                class="flex-1 overflow-y-auto p-4 bg-white border border-gray-200 rounded-xl dark:bg-gray-800 dark:border-gray-700"
              >
                <!-- Messages: 用户 / AI 卡片，UI 友好展示 -->
                <template x-for="msg in messages" :key="messages.indexOf(msg)">
                  <div class="mb-4 flex" :class="msg.role === 'user' ? 'justify-end' : 'justify-start'">
                    <!-- 用户消息：卡片 + 解析后的 skill / 需求 -->
                    <div x-show="msg.role === 'user'"
                         class="max-w-[85%] rounded-2xl border border-gray-200 bg-white px-4 py-3 shadow-theme-xs dark:border-gray-700 dark:bg-white/[0.03]">
                      <div class="flex items-center gap-2 mb-1.5">
                        <span class="inline-flex items-center justify-center gap-1 rounded-full bg-brand-50 px-2.5 py-0.5 text-xs font-medium text-brand-600 dark:bg-brand-500/15 dark:text-brand-400">You</span>
                        <template x-if="window.parseUserSkillMessage(msg.content).skill">
                          <span class="inline-flex items-center justify-center gap-1 rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-600 dark:bg-white/10 dark:text-gray-400" x-text="'Skill: ' + window.parseUserSkillMessage(msg.content).skill"></span>
                        </template>
                      </div>
                      <p class="text-sm text-gray-800 dark:text-white/90" x-text="window.parseUserSkillMessage(msg.content).request || msg.content"></p>
                    </div>
                    <!-- AI 消息：成功/失败卡片 + 步骤 + 下载 + 原始 JSON 折叠 -->
                    <div x-show="msg.role === 'assistant' && window.formatSkillResult(msg.content).isSkillResult"
                         class="max-w-[85%] w-full rounded-2xl border dark:border-gray-700 dark:bg-white/[0.03] overflow-hidden shadow-theme-xs"
                         :class="window.formatSkillResult(msg.content).allOk ? 'border-success-500/40 bg-success-50 dark:bg-success-500/10' : 'border-error-500/40 bg-error-50 dark:bg-error-500/10'">
                      <div class="flex items-start gap-3 p-4">
                        <div class="shrink-0 mt-0.5" :class="window.formatSkillResult(msg.content).allOk ? 'text-success-500' : 'text-error-500'">
                          <svg x-show="window.formatSkillResult(msg.content).allOk" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm3.707 8.707l-4 4a1 1 0 01-1.414 0l-2-2a1 1 0 111.414-1.414L11 12.586l3.293-3.293a1 1 0 011.414 1.414z"/></svg>
                          <svg x-show="!window.formatSkillResult(msg.content).allOk" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm1 8v4h-2v-4h2zm0 6v2h-2v-2h2z"/></svg>
                        </div>
                        <div class="min-w-0 flex-1">
                          <h4 class="text-sm font-semibold text-gray-800 dark:text-white/90 mb-1">AI 执行结果</h4>
                          <p class="text-sm text-gray-600 dark:text-gray-400 mb-3" x-text="window.formatSkillResult(msg.content).summary"></p>
                          <div class="mb-3">
                            <p class="text-xs font-medium text-gray-500 dark:text-gray-500 mb-1.5">执行步骤</p>
                            <ul class="space-y-1">
                              <template x-for="(step, i) in window.formatSkillResult(msg.content).steps" :key="i">
                                <li class="flex items-center gap-2 text-sm">
                                  <span class="shrink-0 inline-flex items-center justify-center rounded-full w-5 h-5 text-xs font-medium"
                                        :class="step.success ? 'bg-success-100 text-success-600 dark:bg-success-500/20 dark:text-success-400' : 'bg-error-100 text-error-600 dark:bg-error-500/20 dark:text-error-400'"
                                        x-text="i + 1"></span>
                                  <span class="text-gray-700 dark:text-gray-300" x-text="step.action"></span>
                                  <span class="shrink-0 inline-flex items-center justify-center gap-1 rounded-full px-2 py-0.5 text-xs font-medium"
                                        :class="step.success ? 'bg-success-50 text-success-600 dark:bg-success-500/15 dark:text-success-500' : 'bg-error-50 text-error-600 dark:bg-error-500/15 dark:text-error-500'"
                                        x-text="step.success ? '成功' : '失败'"></span>
                                </li>
                              </template>
                            </ul>
                          </div>
                          <template x-if="window.getSkillResultOutputPaths(msg.content).length > 0">
                            <div class="mb-3">
                              <p class="text-xs font-medium text-gray-500 dark:text-gray-500 mb-2">产出文件 · 下载</p>
                              <div class="flex flex-wrap gap-2">
                                <template x-for="fp in window.getSkillResultOutputPaths(msg.content)" :key="fp">
                                  <a :href="window.getDownloadUrl(fp)" download target="_blank" rel="noopener"
                                     class="inline-flex items-center gap-2 rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white shadow-theme-xs transition hover:bg-brand-600">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                                    <span x-text="(fp.split(/[\/\\\\]/).pop() || fp) + ' · 另存为'"></span>
                                  </a>
                                </template>
                              </div>
                            </div>
                          </template>
                          <details class="group">
                            <summary class="cursor-pointer text-xs font-medium text-brand-600 dark:text-brand-400 hover:underline">► 查看原始 JSON</summary>
                            <pre class="json-block mt-2 text-gray-700 dark:text-gray-300 whitespace-pre-wrap break-words" x-text="window.formatSkillResult(msg.content).json"></pre>
                          </details>
                        </div>
                      </div>
                      <template x-if="msg.plan">
                        <div class="border-t border-gray-200 dark:border-gray-700 px-4 py-2 bg-gray-50/50 dark:bg-white/[0.02]">
                          <details class="group">
                            <summary class="cursor-pointer text-xs font-medium text-brand-600 dark:text-brand-400 hover:underline">► View Plan</summary>
                            <pre class="json-block mt-2 text-gray-700 dark:text-gray-300 whitespace-pre-wrap break-words" x-text="JSON.stringify(msg.plan, null, 2)"></pre>
                          </details>
                        </div>
                      </template>
                    </div>
                    <!-- AI 消息：非 skill 结果（如错误提示） -->
                    <div x-show="msg.role === 'assistant' && !window.formatSkillResult(msg.content).isSkillResult"
                         class="max-w-[85%] rounded-2xl border border-gray-200 bg-white px-4 py-3 shadow-theme-xs dark:border-gray-700 dark:bg-white/[0.03]">
                      <div class="flex items-center gap-2 mb-1.5">
                        <span class="inline-flex items-center justify-center gap-1 rounded-full bg-blue-light-50 px-2.5 py-0.5 text-xs font-medium text-blue-light-600 dark:bg-blue-light-500/15 dark:text-blue-light-400">AI</span>
                      </div>
                      <p class="text-sm text-gray-800 dark:text-white/90 whitespace-pre-wrap" x-text="window.formatSkillResult(msg.content).text || msg.content"></p>
                    </div>
                  </div>
                </template>

                <!-- Empty state -->
                <template x-if="messages.length === 0">
                  <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                    <svg class="mx-auto mb-2 text-gray-400" width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path fill-rule="evenodd" clip-rule="evenodd" d="M5.99915 10.2451C6.96564 10.2451 7.74915 11.0286 7.74915 11.9951V12.0051C7.74915 12.9716 6.96564 13.7551 5.99915 13.7551C5.03265 13.7551 4.24915 12.9716 4.24915 12.0051V11.9951C4.24915 11.0286 5.03265 10.2451 5.99915 10.2451ZM17.9991 10.2451C18.9656 10.2451 19.7491 11.0286 19.7491 11.9951V12.0051C19.7491 12.9716 18.9656 13.7551 17.9991 13.7551C17.0326 13.7551 16.2491 12.9716 16.2491 12.0051V11.9951C16.2491 11.0286 17.0326 10.2451 17.9991 10.2451ZM13.7491 11.9951C13.7491 11.0286 12.9656 10.2451 11.9991 10.2451C11.0326 10.2451 10.2491 11.0286 10.2491 11.9951V12.0051C10.2491 12.9716 11.0326 13.7551 11.9991 13.7551C12.9656 13.7551 13.7491 12.9716 13.7491 11.9951V12.0051Z" fill="currentColor" />
                    </svg>
                    <p>Execute a skill to see results here</p>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </main>
        <!-- ===== Main Content End ===== --> 

        <!-- ===== Footer Start ===== -->
        <footer class="border-t border-gray-200 p-4 text-center dark:border-gray-800">
          <p class="text-sm text-gray-500 dark:text-gray-400">
            © 2025 DataOrchestrator. All rights reserved.
          </p>
        </footer>
        <!-- ===== Footer End ===== --> 
      </div>
      <!-- ===== Content Area End ===== --> 
    </div>
    <!-- ===== Page Wrapper End ===== --> 
  </body>
</html>
