<aside
  :class="sidebarToggle ? 'translate-x-0 lg:w-[90px]' : '-translate-x-full'"
  class="sidebar fixed left-0 top-0 z-9999 flex h-screen w-[290px] flex-col overflow-y-hidden border-r border-gray-200 bg-white px-5 dark:border-gray-800 dark:bg-black lg:static lg:translate-x-0"
>
  <!-- SIDEBAR HEADER -->
  <div
    :class="sidebarToggle ? 'justify-center' : 'justify-between'"
    class="flex items-center gap-2 pt-8 sidebar-header pb-7"
  >
    <a href="index.html">
      <span class="text-xl font-bold text-brand-600 dark:text-brand-400" :class="sidebarToggle ? 'hidden' : ''">
        DataOrchestrator
      </span>

      <span
        class="text-xl font-bold text-brand-600 dark:text-brand-400"
        :class="sidebarToggle ? 'lg:block' : 'hidden'"
      >
        DO
      </span>
    </a>
  </div>
  <!-- SIDEBAR HEADER -->

  <div
    class="flex flex-col overflow-y-auto duration-300 ease-linear no-scrollbar"
  >
    <!-- Sidebar Menu -->
    <nav x-data="{
      selected: $persist('Skills'),
      sessions: [],
      searchQuery: '',
      files: [],

      init() {
        // Load sessions from localStorage (safe parse: always array, filter invalid)
        try {
          const savedSessions = localStorage.getItem('chatSessions');
          const parsed = savedSessions ? JSON.parse(savedSessions) : [];
          this.sessions = Array.isArray(parsed) ? parsed.filter(s => s && typeof s.id !== 'undefined') : [];
        } catch (e) {
          this.sessions = [];
        }
        // Load files from localStorage (safe parse)
        try {
          const savedFiles = localStorage.getItem('chatFiles');
          const parsedFiles = savedFiles ? JSON.parse(savedFiles) : [];
          this.files = Array.isArray(parsedFiles) ? parsedFiles.filter(f => f && typeof f.id !== 'undefined' && f.name) : [];
        } catch (e) {
          this.files = [];
        }
        $watch('sessions', value => localStorage.setItem('chatSessions', JSON.stringify(value)));
        $watch('files', value => localStorage.setItem('chatFiles', JSON.stringify(value)));
      },

      get filteredSessions() {
        const q = (this.searchQuery || '').toLowerCase();
        return this.sessions.filter(s =>
          s && (q === '' || (s.title && String(s.title).toLowerCase().includes(q)))
        );
      },

      createNewSession() {
        const newSession = {
          id: 'session-' + Date.now(),
          title: 'New Chat',
          messages: [],
          createdAt: new Date().toISOString()
        };
        this.sessions.unshift(newSession);
        // Navigate to main chat page with new session
        window.location.href = 'main-chat.html?session=' + newSession.id;
      },

      deleteSession(id) {
        if (!confirm('Delete this chat session?')) return;
        this.sessions = this.sessions.filter(s => s.id !== id);
      },

      async uploadFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        // é»˜è®¤çš„æœ¬åœ°å…ƒä¿¡æ¯
        let newFile = {
          id: 'file-' + Date.now(),
          name: file.name,
          type: file.type,
          size: this.formatFileSize(file.size),
          uploadedAt: new Date().toISOString()
        };

        try {
          // è‹¥å…¨å±€å·²æ³¨å…¥ APIClientï¼Œåˆ™çœŸå®žä¸Šä¼ åˆ° opencode_agentï¼Œæ‹¿åˆ°å¯ç”¨äºŽ context.file_path çš„è·¯å¾„
          if (window.APIClient) {
            const client = new window.APIClient('opencode_agent');
            const res = await client.uploadFile(file);
            newFile = {
              ...newFile,
              name: res.fileName || newFile.name,
              type: res.mimeType || newFile.type,
              size: this.formatFileSize(res.fileSize || file.size),
              filePath: res.filePath // e.g. file:/C:/...
            };
          }
        } catch (e) {
          // ä¸Šä¼ å¤±è´¥æ—¶ä¿ç•™æœ¬åœ°è®°å½•ï¼Œä½†æç¤ºç”¨æˆ·ï¼ˆé¿å…é™é»˜å¤±è´¥ï¼‰
          alert((e && e.message) || 'File upload failed');
        } finally {
          this.files.push(newFile);
          event.target.value = ''; // Reset file input
        }
      },

      deleteFile(id) {
        this.files = this.files.filter(f => f.id !== id);
      },

      formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      }
    }">
      <!-- Menu Group -->
      <div>
        <h3 class="mb-4 text-xs uppercase leading-[20px] text-gray-400">
          <span
            class="menu-group-title"
            :class="sidebarToggle ? 'lg:hidden' : ''"
          >
            MENU
          </span>

          <svg
            :class="sidebarToggle ? 'lg:block hidden' : 'hidden'"
            class="mx-auto fill-current menu-group-icon"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              d="M5.99915 10.2451C6.96564 10.2451 7.74915 11.0286 7.74915 11.9951V12.0051C7.74915 12.9716 6.96564 13.7551 5.99915 13.7551C5.03265 13.7551 4.24915 12.9716 4.24915 12.0051V11.9951C4.24915 11.0286 5.03265 10.2451 5.99915 10.2451ZM17.9991 10.2451C18.9656 10.2451 19.7491 11.0286 19.7491 11.9951V12.0051C19.7491 12.9716 18.9656 13.7551 17.9991 13.7551C17.0326 13.7551 16.2491 12.9716 16.2491 12.0051V11.9951C16.2491 11.0286 17.0326 10.2451 17.9991 10.2451ZM13.7491 11.9951C13.7491 11.0286 12.9656 10.2451 11.9991 10.2451C11.0326 10.2451 10.2491 11.0286 10.2491 11.9951V12.0051C10.2491 12.9716 11.0326 13.7551 11.9991 13.7551C12.9656 13.7551 13.7491 12.9716 13.7491 11.9951V12.0051Z"
              fill=""
            />
          </svg>
        </h3>

        <ul class="flex flex-col gap-4 mb-6">
          <!-- Menu Item Skills (only) -->
          <li>
            <a
                href="skill.html"
                class="menu-item group"
                :class="selected === 'Skills' || page === 'skill' ? 'menu-item-active' : 'menu-item-inactive'"
                @click="selected = 'Skills'"
            >
              <svg
                :class="selected === 'Skills' || page === 'skill' ? 'menu-item-icon-active' : 'menu-item-icon-inactive'"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <!-- Sparkles / star burst icon -->
                <path
                  fill="currentColor"
                  d="M12 1L14.09 7.26L21 8.27L16 12.14L17.18 19.02L12 15.77L6.82 19.02L8 12.14L3 8.27L9.91 7.26L12 1Z"
                />
              </svg>

              <span
                class="menu-item-text"
                :class="sidebarToggle ? 'lg:hidden' : ''"
              >
                Skills
              </span>

              <svg
                class="menu-item-arrow"
                :class="[(selected === 'Skills') ? 'menu-item-arrow-active' : 'menu-item-arrow-inactive', sidebarToggle ? 'lg:hidden' : '' ]"
                width="20"
                height="20"
                viewBox="0 0 20 20"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M4.938 6.531C5.231 6.238 5.706 6.238 5.999 6.531L10 10.531L14.001 6.531C14.294 6.238 14.769 6.238 15.062 6.531C15.355 6.824 15.355 7.299 15.062 7.592L10.531 12.123C10.238 12.416 9.763 12.416 9.47 12.123L4.938 7.592C4.645 7.299 4.645 6.824 4.938 6.531Z"
                  fill=""
                />
              </svg>
            </a>
          </li>
        </ul>
      </div>

      <!-- Chat Sessions Group (NEW) -->
      <div :class="sidebarToggle ? 'lg:hidden' : ''">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xs uppercase leading-[20px] text-gray-400">
            CHAT SESSIONS
          </h3>
          <button
            @click="createNewSession()"
            class="flex items-center justify-center w-6 h-6 rounded-full bg-brand-500 hover:bg-brand-600 text-white transition-colors"
            title="New Chat"
          >
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>

        <!-- Session Search -->
        <div class="mb-4">
          <input
            x-model="searchQuery"
            type="text"
            placeholder="Search chats..."
            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg bg-transparent text-gray-800 placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"
          />
        </div>

        <!-- Session List -->
        <ul class="flex flex-col gap-2 mb-6 max-h-64 overflow-y-auto">
          <template x-for="session in filteredSessions" :key="session.id">
            <li class="group">
              <a
                :href="'main-chat.html?session=' + session.id"
                class="flex items-center gap-2 px-3 py-2 rounded-lg transition-colors hover:bg-gray-100 dark:hover:bg-gray-800"
                :class="selected === session.id ? 'bg-brand-50 dark:bg-brand-900/20' : ''"
                @click.prevent="selected = session.id; window.location.href = 'main-chat.html?session=' + session.id"
              >
                <svg class="w-4 h-4 text-gray-400" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span
                  class="flex-1 text-sm text-gray-700 truncate dark:text-gray-300"
                  x-text="session.title || 'Untitled'"
                ></span>
                <button
                  @click.stop="deleteSession(session.id)"
                  class="opacity-0 group-hover:opacity-100 p-1 text-gray-400 hover:text-red-500 transition-opacity"
                  title="Delete session"
                >
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </a>
            </li>
          </template>
          <li x-show="filteredSessions.length === 0" class="text-center py-4 text-sm text-gray-500 dark:text-gray-400">
            No chats found
          </li>
        </ul>
      </div>

      <!-- Files Group (NEW) -->
      <div :class="sidebarToggle ? 'lg:hidden' : ''">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xs uppercase leading-[20px] text-gray-400">
            FILES
          </h3>
          <label class="flex items-center justify-center w-6 h-6 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-600 hover:text-gray-700 cursor-pointer transition-colors" title="Upload File">
            <input type="file" @change="uploadFile($event)" class="hidden" />
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </label>
        </div>

        <!-- File List -->
        <ul class="flex flex-col gap-2 mb-6 max-h-48 overflow-y-auto">
          <template x-for="file in files" :key="file.id">
            <li
              class="group flex items-center gap-2 px-3 py-2 rounded-lg transition-colors hover:bg-gray-100 dark:hover:bg-gray-800"
              @click="window.selectSkillFileFromSidebar && window.selectSkillFileFromSidebar(file)"
              title="Click to use this file in Skills"
            >
              <span class="text-lg" x-text="(file.name && file.name.endsWith('.pdf')) ? 'ðŸ“„' : ((file.name && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) ? 'ðŸ“Š' : 'ðŸ“‹')"></span>
              <span class="flex-1 text-sm text-gray-700 truncate dark:text-gray-300" x-text="file.name || 'Unnamed'"></span>
              <button
                @click.stop="deleteFile(file.id)"
                class="opacity-0 group-hover:opacity-100 p-1 text-gray-400 hover:text-red-500 transition-opacity"
                title="Delete file"
              >
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </li>
          </template>
          <li x-show="files.length === 0" class="text-center py-4 text-sm text-gray-500 dark:text-gray-400">
            No files uploaded
          </li>
        </ul>
      </div>

      <!-- Menu Group -->
      <div>
        <h3 class="mb-4 text-xs uppercase leading-[20px] text-gray-400">
          <span
            class="menu-group-title"
            :class="sidebarToggle ? 'lg:hidden' : ''"
          >
            OTHERS
          </span>

          <svg
            :class="sidebarToggle ? 'lg:block hidden' : 'hidden'"
            class="mx-auto fill-current menu-group-icon"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              d="M5.99915 10.2451C6.96564 10.2451 7.74915 11.0286 7.74915 11.9951V12.0051C7.74915 12.9716 6.96564 13.7551 5.99915 13.7551C5.03265 13.7551 4.24915 12.9716 4.24915 12.0051V11.9951C4.24915 11.0286 5.03265 10.2451 5.99915 10.2451ZM17.9991 10.2451C18.9656 10.2451 19.7491 11.0286 19.7491 11.9951V12.0051C19.7491 12.9716 18.9656 13.7551 17.9991 13.7551C17.0326 13.7551 16.2491 12.9716 16.2491 12.0051V11.9951C16.2491 11.0286 17.0326 10.2451 17.9991 10.2451ZM13.7491 11.9951C13.7491 11.0286 12.9656 10.2451 11.9991 10.2451C11.0326 10.2451 10.2491 11.0286 10.2491 11.9951V12.0051C10.2491 12.9716 11.0326 13.7551 11.9991 13.7551C12.9656 13.7551 13.7491 12.9716 13.7491 11.9951V12.0051Z"
              fill=""
            />
          </svg>
        </h3>

        <ul class="flex flex-col gap-4 mb-6">
          <!-- Menu Item Settings -->
          <li>
            <a
              href="settings.html"
              class="menu-item group"
              :class="selected === 'Settings' || page === 'settings' ? 'menu-item-active' : 'menu-item-inactive'"
              @click="selected = 'Settings'"
            >
              <svg
                :class="selected === 'Settings' || page === 'settings' ? 'menu-item-icon-active' : 'menu-item-icon-inactive'"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  fill-rule="evenodd"
                  clip-rule="evenodd"
                  d="M9.86816 3.55859C9.53339 2.7138 8.46656 2.7138 8.13178 3.55859L7.51316 5.10558C7.40789 5.37129 7.17236 5.55765 6.89885 5.58935L5.23685 5.38497C4.33568 5.27106 3.70429 6.24961 4.14898 7.03696L5.04765 8.63464C5.17523 8.86287 5.15421 9.14936 4.99446 9.35629L4.00004 10.6449C3.46546 11.3385 3.85268 12.3639 4.71016 12.5908L6.34633 13.0306C6.61706 13.1048 6.80913 13.3538 6.82312 13.6339L6.90753 15.3112C6.95291 16.2198 8.04884 16.6468 8.66025 16.0011L9.78592 14.809C9.9665 14.6182 10.2309 14.5628 10.4677 14.6742L11.9987 15.4138C12.8251 15.8143 13.7648 15.1457 13.6491 14.2371L13.4386 12.5529C13.4022 12.2626 13.5253 11.9812 13.749 11.8124L15.1006 10.797C15.8482 10.2405 15.7323 9.11286 14.8829 8.8515L13.279 8.36116C13.0158 8.2795 12.8232 8.04826 12.7874 7.7739L12.5698 6.09399C12.4538 5.18424 11.3796 4.75972 10.7673 5.40451L9.63684 6.59176C9.456 6.78229 9.1915 6.83753 8.95479 6.726L7.42419 5.98654C7.22874 5.89466 7.01598 5.72632 6.90127 5.50199L6.39986 4.50261L6.51916 3.55859H9.86816ZM12 14C12.0003 14 12.0007 14 12.001 14L11.9999 14.0001C11.9999 14.0001 11.9999 14.0001 12 14ZM10.4999 10.5C10.4999 10.9142 10.8357 11.25 11.2499 11.25H12.7499C13.1641 11.25 13.4999 10.9142 13.4999 10.5C13.4999 10.0858 13.1641 9.75 12.7499 9.75H11.2499C10.8357 9.75 10.4999 10.0858 10.4999 10.5Z"
                  fill=""
                />
              </svg>

              <span
                class="menu-item-text"
                :class="sidebarToggle ? 'lg:hidden' : ''"
              >
                Settings
              </span>

              <svg
                class="menu-item-arrow"
                :class="[(selected === 'Settings') ? 'menu-item-arrow-active' : 'menu-item-arrow-inactive', sidebarToggle ? 'lg:hidden' : '' ]"
                width="20"
                height="20"
                viewBox="0 0 20 20"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M4.938 6.531C5.231 6.238 5.706 6.238 5.999 6.531L10 10.531L14.001 6.531C14.294 6.238 14.769 6.238 15.062 6.531C15.355 6.824 15.355 7.299 15.062 7.592L10.531 12.123C10.238 12.416 9.763 12.416 9.47 12.123L4.938 7.592C4.645 7.299 4.645 6.824 4.938 6.531Z"
                  fill=""
                />
              </svg>
            </a>
          </li>

          <!-- Menu Item Logout -->
          <li>
            <a
              href="#"
              @click.prevent="window.logout && window.logout()"
              class="menu-item group"
            >
              <svg
                class="menu-item-icon-inactive"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M10.75 12C10.75 11.5858 10.4142 11.25 10 11.25C9.58579 11.25 9.25 11.5858 9.25 12V16.1893L7.53033 14.4697C7.23744 14.1768 6.76256 14.1768 6.46967 14.4697C6.17678 14.7626 6.17678 15.2374 6.46967 15.5303L9.46967 18.5303C9.76256 18.8232 10.2374 18.8232 10.5303 18.5303L13.5303 15.5303C13.8232 15.2374 13.8232 14.7626 13.5303 14.4697C13.2374 14.1768 12.7626 14.1768 12.4697 14.4697L10.75 16.1893V12Z"
                  fill="currentColor"
                />
                <path
                  fill-rule="evenodd"
                  clip-rule="evenodd"
                  d="M4.75 4.5C4.75 3.25736 5.75736 2.25 7 2.25H17C18.2426 2.25 19.25 3.25736 19.25 4.5V19.5C19.25 20.7426 18.2426 21.75 17 21.75H7C5.75736 21.75 4.75 20.7426 4.75 19.5V12C4.75 11.5858 5.08579 11.25 5.5 11.25C5.91421 11.25 6.25 11.5858 6.25 12V19.5C6.25 19.9142 6.58579 20.25 7 20.25H17C17.4142 20.25 17.75 19.9142 17.75 19.5V4.5C17.75 4.08579 17.4142 3.75 17 3.75H7C6.58579 3.75 6.25 4.08579 6.25 4.5V9C6.25 9.41421 5.91421 9.75 5.5 9.75C5.08579 9.75 4.75 9.41421 4.75 9V4.5Z"
                  fill="currentColor"
                />
              </svg>

              <span
                class="menu-item-text"
                :class="sidebarToggle ? 'lg:hidden' : ''"
              >
                Logout
              </span>
            </a>
          </li>
        </ul>
      </div>
    </nav>
  </div>
</aside>
